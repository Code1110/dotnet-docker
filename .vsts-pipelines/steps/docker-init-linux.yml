parameters:
  repoVolume: ''
  setupImageBuilder: true
  setupTestRunner: false

steps:
  - template: docker-cleanup-linux.yml

  - ${{ if ne(parameters.repoVolume, '') }}:
    - script: $(Build.Repository.LocalPath)/scripts/pull-image.sh buildpack-deps:stretch-scm
      displayName: Pull Image buildpack-deps:stretch-scm
    - script: docker run --rm -v $repoVolume:/repo buildpack-deps:stretch-scm git clone https://github.com/dotnet/dotnet-docker.git /repo
      displayName: Clone Repo
      env:
        repoVolume: ${{ parameters.repoVolume }}
    - script: docker run --rm -v $repoVolume:/repo -w /repo buildpack-deps:stretch-scm git checkout $(Build.SourceVersion)
      displayName: Checkout Source
      env:
        repoVolume: ${{ parameters.repoVolume }}

  - ${{ if parameters.setupImageBuilder }}:
    - script: echo "##vso[task.setvariable variable=imageBuilder.image]microsoft/dotnet-buildtools-prereqs:image-builder-debian-20180904220918"
    - script: $(Build.Repository.LocalPath)/scripts/pull-image.sh $(imageBuilder.image)
      displayName: Pull Image Builder

  - ${{ if parameters.setupTestRunner }}:
    - script: echo "##vso[task.setvariable variable=testrunner.image]microsoft/dotnet-buildtools-prereqs:debian-stretch-docker-testrunner-63f2145-20184325094343"
    - script: $(Build.Repository.LocalPath)/scripts/pull-image.sh $(testrunner.image)
      displayName: Pull Image Builder